# BITCH Configuration
# See DOCUMENTATION.md for complete documentation

[network]
gcs_listen_port = 14550
gcs_listen_address = "0.0.0.0"
router_address = "127.0.0.1"
router_port = 14551

[logging]
level = "info"  # trace, debug, info, warn, error

[plugins]
directory = "plugins"

[plugins.load]
arm_notifier = "arm_notifier.lua"
# webhook_example = "webhook_example.lua"

[modifiers]
directory = "modifiers"

[modifiers.load]
always_armed = "always_armed.lua"

# Rules - See DOCUMENTATION.md for complete rule system documentation
# Direction: "gcs_to_router" (default), "router_to_gcs", or "both"
# Actions: forward, block, modify, delay, batch

[[rules]]
name = "arm_sync"
message_type = "COMMAND_LONG"
actions = ["batch", "delay"]
batch_count = 2
batch_timeout_seconds = 120
batch_timeout_forward = true
batch_key = "arm_swarm"
batch_system_id_field = "target_system"
delay_seconds = 5
auto_ack = true
plugins = ["arm_notifier"]
direction = "gcs_to_router"
description = "Synchronize ARM commands across 2 drones, then delay 5s before arming"

[rules.conditions]
command = { type = "MAV_CMD_COMPONENT_ARM_DISARM" }
param1 = 1.0

[rules.ack]
message_type = "COMMAND_ACK"
source_system_field = "target_system"
source_component_field = "target_component"
fields = { result = { type = "MAV_RESULT_ACCEPTED" } }
copy_fields = { command = "command", target_system = "header.system_id", target_component = "header.component_id" }

# Trigger: Activate always_armed rule for 60 seconds when drones ARM
# Pass full triggering context so modifier can filter by target_system
[rules.triggers]
activate_rules = ["show_always_armed"]
duration_seconds = 1
on_match = true
context = true

[[rules]]
name = "mission_start_sync"
message_type = "COMMAND_LONG"
actions = ["batch", "delay"]
batch_count = 2
batch_timeout_seconds = 120
batch_timeout_forward = true
batch_key = "mission_start_swarm"
batch_system_id_field = "target_system"
delay_seconds = 10
auto_ack = true
direction = "gcs_to_router"
description = "Synchronize MISSION_START commands across 2 drones, then delay 7s before starting"
[rules.conditions]
command = { type = "MAV_CMD_MISSION_START" }

[rules.ack]
message_type = "COMMAND_ACK"
source_system_field = "target_system"
source_component_field = "target_component"
fields = { result = { type = "MAV_RESULT_ACCEPTED" } }
copy_fields = { command = "command", target_system = "header.system_id", target_component = "header.component_id" }

# Make all drones appear armed in HEARTBEAT messages
# Activated by ARM trigger for 1 second
[[rules]]
name = "show_always_armed"
message_type = "HEARTBEAT"
actions = ["modify", "forward"]
modifier = "always_armed"
direction = "router_to_gcs"
enabled_by_default = false
description = "Show drones as always armed (activated by ARM trigger)"
